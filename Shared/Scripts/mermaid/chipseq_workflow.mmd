flowchart TD
    Start([Raw FASTQ Files<br/>fastq/fastq.gz])
    
    Start --> FastQC_Raw
    
    FastQC_Raw[FastQC Quality Control<br/>fastqc_raw<br/>Initial QC]
    FastQC_Raw -->|<sample>_fastqc.html| Cutadapt[Adapter Trimming<br/>cutadapt<br/>Remove adapters]
    
    Cutadapt -->|<sample>.adapter_trimmed.fastq| Trimmomatic[Quality Trimming<br/>trimmomatic<br/>Quality filtering]
    
    Trimmomatic -->|<sample>.quality_trimmed.fastq| FastQC_Trimmed[FastQC on Trimmed<br/>fastqc_trimmed<br/>QC after trimming]
    
    FastQC_Trimmed -->|<sample>.trimmed_fastqc.html| Trim50bp[Trim to 50bp<br/>trim_50bp<br/>Python script]
    
    Trim50bp -->|<sample>.50bp.fastq| Split{Parallel<br/>Mapping}
    
    %% Genome Mapping Path
    Split -->|Genome Path| BowtieGenome[Bowtie Genome Mapping<br/>bowtie_mapping<br/>Map to dm6, v=2, k=1]
    
    BowtieGenome -->|<sample>.sam| SAMtoBAM[SAM to BAM<br/>samtools_view<br/>Convert format]
    
    SAMtoBAM -->|<sample>.bam| SortIndexBAM[Sort and Index BAM<br/>samtools_sort_and_index<br/>Prepare for processing]
    
    SortIndexBAM -->|<sample>.sorted.bam + .bai| RemoveMito[Remove Mitochondrial<br/>remove_mitochondrial_reads<br/>Filter chrM]
    
    RemoveMito -->|<sample>.mito_removed.bam| SortNoMito[Sort No-Mito BAM<br/>samtools_sort_no_mito<br/>Re-sort after filtering]
    
    SortNoMito -->|<sample>.no_mito_sorted.bam| RemoveDup[Remove Duplicates<br/>samtools_rmdup<br/>Remove PCR duplicates]
    
    RemoveDup -->|<sample>.rmdup.bam| GenomeEnd([Deduplicated<br/>Genome BAM])
    
    %% Vector Mapping Path
    Split -->|Vector Path| BowtieVector[Bowtie Vector Mapping<br/>bowtie_vector_mapping<br/>Map to 42AB_UBIG]
    
    BowtieVector -->|<sample>.vectoronly.sam| VectorSAMtoBAM[SAM to BAM Vector<br/>samtools_view_vector<br/>Convert format]
    
    VectorSAMtoBAM -->|<sample>.vectoronly.bam| SortIndexVector[Sort and Index Vector<br/>samtools_sort_and_index_vector<br/>Prepare for analysis]
    
    SortIndexVector -->|<sample>.vectoronly.dup.bam| VectorEnd([Vector<br/>Sorted BAM])
    
    %% Final Analysis from both paths
    GenomeEnd --> FinalAnalysis[Final Analyses]
    VectorEnd --> FinalAnalysis
    
    FinalAnalysis --> BigWig[Generate BigWig<br/>make_bigwig<br/>Wiggle → BigWig]
    FinalAnalysis --> Enrichment[ChIP vs Input<br/>make_enrichment_track<br/>Bin chopping]
    FinalAnalysis --> Coverage[Coverage Analysis<br/>bam_coverage<br/>Multiple bin sizes: 10,100,1000bp]
    FinalAnalysis --> Transposon[Transposon Coverage<br/>bam_coverage_transposon<br/>42AB & 20A regions]
    
    BigWig -->|<sample>.bigwig| BigWigOut([BigWig Tracks])
    Enrichment -->|<chip>_vs_<input>.enrichment.bigwig| EnrichOut([Enrichment Tracks])
    Coverage -->|<sample>.<binsize>.bg4<br/>Plus/Minus strands| CoverageOut([Coverage Files])
    Transposon -->|<sample>.<binsize>.42AB.bg4<br/><sample>.<binsize>.20A.bg4| TransposonOut([Transposon Files])
    
    BigWigOut --> FinalOutputs
    EnrichOut --> FinalOutputs
    CoverageOut --> FinalOutputs
    TransposonOut --> FinalOutputs
    
    FinalOutputs[Final Outputs:<br/>• BigWig files .bigwig<br/>• Enrichment tracks .bigwig<br/>• Coverage analysis .bg4<br/>• Transposon analysis .bg4<br/>• BAM files .bam<br/>• Quality reports .html, .zip]
    
    FinalOutputs --> End([End])
    
    %% Styling
    style Start fill:#e1f5ff
    style End fill:#e1f5ff
    style FastQC_Raw fill:#fff4e6
    style FastQC_Trimmed fill:#fff4e6
    style Cutadapt fill:#f3e5f5
    style Trimmomatic fill:#f3e5f5
    style Trim50bp fill:#f3e5f5
    style BowtieGenome fill:#e8f5e9
    style BowtieVector fill:#e8f5e9
    style SAMtoBAM fill:#e3f2fd
    style VectorSAMtoBAM fill:#e3f2fd
    style SortIndexBAM fill:#e3f2fd
    style SortIndexVector fill:#e3f2fd
    style RemoveMito fill:#e3f2fd
    style SortNoMito fill:#e3f2fd
    style RemoveDup fill:#e3f2fd
    style BigWig fill:#fff9c4
    style Enrichment fill:#fff9c4
    style Coverage fill:#fff9c4
    style Transposon fill:#fff9c4
    style Split fill:#ffebee
    style FinalAnalysis fill:#f3e5f5
    style GenomeEnd fill:#e0e0e0
    style VectorEnd fill:#e0e0e0
    style BigWigOut fill:#e0e0e0
    style EnrichOut fill:#e0e0e0
    style CoverageOut fill:#e0e0e0
    style TransposonOut fill:#e0e0e0
    style FinalOutputs fill:#fff9c4
